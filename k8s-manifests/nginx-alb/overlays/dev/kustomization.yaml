apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namespace: nginx-alb

commonLabels:
  env: dev

# SINGLE SOURCE OF TRUTH: Change ONLY this one line
# Valid versions: 1.27-alpine, 1.28-alpine, 1.29-alpine
# Invalid for testing: 99.99-alpine
images:
  - name: public.ecr.aws/nginx/nginx
    newName: nginx
    newTag: 1.28-alpine  # ‚Üê CHANGE THIS ONE VALUE (updates both image AND env var)

# Patches
patchesStrategicMerge:
  - configmap-patch.yaml
  - nginx-config-patch.yaml

# JSON patch to automatically sync NGINX_VERSION env var with the image tag above
patches:
  - target:
      kind: Deployment
      name: nginx
    patch: |-
      - op: replace
        path: /spec/template/spec/initContainers/0/env/0/value
        value: 1.28-alpine
